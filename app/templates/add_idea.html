{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header text-white" style="background-color: var(--primary-color);">
            <h4 class="mb-0 d-flex align-items-center">
                <a href="{{ url_for('public.index') }}" class="btn btn-sm me-2" style="background-color: white; color: var(--primary-color);">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <span>Добавить новую идею</span>
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="ideaForm">
                {{ form.hidden_tag() }}
                
                <!-- Основная информация -->
                <div class="mb-4">
                    <h5 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                        <i class="bi bi-info-circle me-2"></i>Основная информация
                    </h5>
                    
                    <!-- Заголовок и категория -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <div class="form-group">
                                {{ form.title.label(class="form-label fw-medium") }}
                                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), 
                                placeholder="Дайте краткое название", 
                                required=True) }}
                                {% for error in form.title.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.category.label(class="form-label fw-medium") }}
                                {{ form.category(class="form-select" + (" is-invalid" if form.category.errors else ""), 
                                id="categorySelect") }}
                                
                                <!-- Блок для отображения описания категории -->
                                <div id="categoryDescription" class="mt-2 p-2 bg-light rounded small" style="display: none;">
                                    <i class="bi bi-info-circle me-1 text-primary"></i>
                                    <span id="descriptionText"></span>
                                </div>
                                
                                {% for error in form.category.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Контактные данные -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.author_name.label(class="form-label fw-medium") }}
                                {{ form.author_name(class="form-control" + (" is-invalid" if form.author_name.errors else ""), 
                                placeholder="Оставьте пустым, если хотите сохранить анонимность") }}
                                {% for error in form.author_name.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.contact_email.label(class="form-label fw-medium") }}
                                {{ form.contact_email(class="form-control" + (" is-invalid" if form.contact_email.errors else ""), 
                                placeholder="IvanPM@rostest.ru (укажите рабочую почту)") }}
                                {% for error in form.contact_email.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Информационный блок -->
                    <div class="alert alert-info mb-3 p-2" style="border-left: 3px solid #0d6efd;">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill me-2" style="color: #0d6efd;"></i>
                            <div>
                                <h6 class="mb-1" style="color: #0d6efd;">Почему лучше указать контакты?</h6>
                                <p class="mb-0 small">
                                    Идеи с указанным именем и адресом получают приоритет при рассмотрении.<br>
                                    <strong>Ваши данные видны только модераторам</strong> и используются исключительно для обратной связи.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Детали идеи -->
                <div class="mb-4">
                    <div class="mb-3">
                        {{ form.essence.label(class="form-label fw-medium") }}
                        {{ form.essence(class="form-control" + (" is-invalid" if form.essence.errors else ""), 
                           rows=3, 
                           placeholder="Напишите, что можно улучшить и почему", 
                           required=True) }}
                        {% for error in form.essence.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.solution.label(class="form-label fw-medium") }}
                        {{ form.solution(class="form-control" + (" is-invalid" if form.solution.errors else ""), 
                           rows=3, 
                           placeholder="Напишите, как можно улучшить процесс/реализовать идею", 
                           required=True) }}
                        {% for error in form.solution.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label fw-medium") }}
                        {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), 
                           rows=3, 
                           placeholder="Если что-то важное не вошло в описание идеи и вариантов решения") }}
                        {% for error in form.description.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Прикрепленные файлы -->
                <div class="mb-4">
                    <h5 class="border-bottom pb-2 d-flex align-items-center gap-2" style="color: var(--primary-color);">
                        <i class="bi bi-paperclip"></i>
                        <span>Прикрепленные файлы</span>
                    </h5>
                    
                    <div class="mb-3">
                        {{ form.attachments.label(class="form-label fw-medium") }}
                        {{ form.attachments(class="form-control" + (" is-invalid" if form.attachments.errors else ""), 
                           multiple="multiple",
                           id="fileInput") }}
                        <div class="form-text">
                            Можно прикрепить несколько файлов (jpg, png, pdf, doc, docx, xls, xlsx).<br>
                            Максимальный размер файла: 10MB.
                        </div>
                        {% for error in form.attachments.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div id="filePreview" class="mb-3 d-none">
                        <h6>Выбранные файлы:</h6>
                        <ul class="list-group" id="fileList"></ul>
                    </div>
                </div>
                
                <!-- Кнопка отправки -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-lg" style="background-color: var(--primary-color); color: white;" id="submitBtn">
                        <i class="bi bi-send-fill me-2"></i>Отправить на модерацию
                    </button>
                    <a href="{{ url_for('public.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Отменить
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript для предпросмотра выбранных файлов, описания категорий и обработки формы -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('categorySelect');
    const descriptionContainer = document.getElementById('categoryDescription');
    const descriptionText = document.getElementById('descriptionText');
    const fileInput = document.getElementById('fileInput'); // Добавляем ссылку на fileInput
    const fileList = document.getElementById('fileList'); // Добавляем ссылку на fileList
    const filePreview = document.getElementById('filePreview'); // Добавляем ссылку на filePreview
    const ideaForm = document.getElementById('ideaForm'); // Добавляем ссылку на ideaForm
    const submitBtn = document.getElementById('submitBtn'); // Добавляем ссылку на submitBtn
    
    // Создаем объект с описаниями категорий прямо в JavaScript
    const categoryDescriptions = {
        {% for category in form.category.choices %}
            "{{ category[0] }}": "{{ form.category.descriptions.get(category[0], '') }}",
        {% endfor %}
    };
    
    // Функция для обновления описания категории
    function updateCategoryDescription() {
        const selectedValue = categorySelect.value;
        
        // Если выбрана пустая категория, скрываем описание
        if (!selectedValue || selectedValue === '') {
            descriptionContainer.style.display = 'none';
            return;
        }
        
        const description = categoryDescriptions[selectedValue];
        
        if (description && description.trim() !== '') {
            descriptionText.textContent = description;
            descriptionContainer.style.display = 'block';
        } else {
            descriptionContainer.style.display = 'none';
        }
    }
    
    // Обработчик изменения категории
    if (categorySelect) {
        categorySelect.addEventListener('change', updateCategoryDescription);
        // Инициализация описания при загрузке
        updateCategoryDescription();
    }
    
    // Обработка выбора файлов
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            fileList.innerHTML = '';
            
            if (this.files.length > 0) {
                filePreview.classList.remove('d-none');
                
                for (let i = 0; i < this.files.length; i++) {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const fileInfo = document.createElement('span');
                    fileInfo.innerHTML = `<i class="bi bi-file-earmark"></i> ${this.files[i].name} (${formatFileSize(this.files[i].size)})`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-outline-danger';
                    removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    removeBtn.setAttribute('aria-label', 'Удалить файл');
                    removeBtn.onclick = (function(file) {
                        return function(e) {
                            e.preventDefault();
                            const dt = new DataTransfer();
                            for (let j = 0; j < fileInput.files.length; j++) {
                                if (fileInput.files[j] !== file) {
                                    dt.items.add(fileInput.files[j]);
                                }
                            }
                            fileInput.files = dt.files;
                            fileInput.dispatchEvent(new Event('change'));
                        };
                    })(this.files[i]);
                    
                    listItem.appendChild(fileInfo);
                    listItem.appendChild(removeBtn);
                    fileList.appendChild(listItem);
                }
            } else {
                filePreview.classList.add('d-none');
            }
        });
    }
    
    // Обработка отправки формы
    if (ideaForm) {
        ideaForm.addEventListener('submit', function(e) {
            // Проверяем, что выбрана категория
            if (categorySelect && (!categorySelect.value || categorySelect.value === '')) {
                e.preventDefault(); // Останавливаем отправку формы
                alert('Пожалуйста, выберите категорию для идеи');
                categorySelect.focus();
                return false;
            }
            
            // Если проверка прошла, показываем индикатор загрузки
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Отправка...';
        });
    }
        
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}